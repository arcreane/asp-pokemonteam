@{
    ViewData["Title"] = "Connexion & Inscription";
}

<h2>Connexion</h2>

<input id="loginEmail" placeholder="Email" type="email" value="adam@adam.adam">
<input id="loginPassword" placeholder="Mot de passe" type="password" value="adamadam">
<button id="loginBtn">Se connecter</button>

<p id="loginMsg"></p>

<h2>Inscription</h2>

<input id="registerEmail" placeholder="Email" type="email">
<input id="registerPassword" placeholder="Mot de passe" type="password">
<button id="registerBtn">S'inscrire</button>

<p id="registerMsg"></p>

<script>
document.getElementById('loginBtn').addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
        const res = await fetch('/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
            credentials: 'include'
        });

        // CORRECTION: Toujours vérifier le statut d'abord
        if (res.status === 200) {
            // Connexion réussie - ne pas essayer de lire la réponse comme JSON
            document.getElementById('loginMsg').innerText = "Connexion réussie !";
            document.getElementById('loginMsg').style.color = "green";
            
            // Redirection immédiate
            setTimeout(() => {
                window.location.href = '/PokemonArena';
            }, 500);
        } else {
            // Erreur - lire le message d'erreur
            const errorText = await res.text();
            document.getElementById('loginMsg').innerText = errorText || "Erreur de connexion";
            document.getElementById('loginMsg').style.color = "red";
        }
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('loginMsg').innerText = "Erreur de connexion";
        document.getElementById('loginMsg').style.color = "red";
    }
});

document.getElementById('registerBtn').addEventListener('click', async () => {
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    
    try {
        const res = await fetch('/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
            credentials: 'include'
        });

        if (res.status === 200) {
            document.getElementById('registerMsg').innerText = "Inscription réussie ! Vous pouvez maintenant vous connecter.";
            document.getElementById('registerMsg').style.color = "green";
        } else {
            const errorText = await res.text();
            document.getElementById('registerMsg').innerText = errorText || "Erreur d'inscription";
            document.getElementById('registerMsg').style.color = "red";
        }
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('registerMsg').innerText = "Erreur d'inscription";
        document.getElementById('registerMsg').style.color = "red";
    }
});
</script>