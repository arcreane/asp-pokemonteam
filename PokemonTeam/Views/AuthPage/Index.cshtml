@{
    ViewData["Title"] = "Connexion & Inscription";
}

<h2>Connexion</h2>

<input id="loginEmail" placeholder="Email" type="email" value="adam@adam.adam">
<input id="loginPassword" placeholder="Mot de passe" type="password" value="adamadam">
<button id="loginBtn">Se connecter</button>

<p id="loginMsg"></p>

<h2>Inscription</h2>

<input id="registerEmail" placeholder="Email" type="email">
<input id="registerPassword" placeholder="Mot de passe" type="password">
<button id="registerBtn">S'inscrire</button>

<p id="registerMsg"></p>

<script>
document.getElementById('loginBtn').addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
        const res = await fetch('/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
            credentials: 'include'
        });

        if (res.ok) {
            // CORRECTION: Lire la réponse JSON même en cas de succès
            const data = await res.json();
            document.getElementById('loginMsg').innerText = data.message || "Connexion réussie !";
            document.getElementById('loginMsg').style.color = "green";
            
            // Redirection après un court délai
            setTimeout(() => {
                window.location.href = '/PokemonArena';
            }, 1000);
        } else {
            // Gestion des erreurs
            let errorMessage = "Erreur de connexion";
            try {
                const errorData = await res.json();
                errorMessage = errorData.message || errorMessage;
            } catch {
                const errorText = await res.text();
                errorMessage = errorText || errorMessage;
            }
            
            document.getElementById('loginMsg').innerText = errorMessage;
            document.getElementById('loginMsg').style.color = "red";
        }
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('loginMsg').innerText = "Erreur de connexion";
        document.getElementById('loginMsg').style.color = "red";
    }
});

document.getElementById('registerBtn').addEventListener('click', async () => {
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    
    try {
        const res = await fetch('/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
            credentials: 'include'
        });

        if (res.ok) {
            const data = await res.json();
            document.getElementById('registerMsg').innerText = data.message || "Inscription réussie ! Vous pouvez maintenant vous connecter.";
            document.getElementById('registerMsg').style.color = "green";
            
            // Vider les champs
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
        } else {
            let errorMessage = "Erreur d'inscription";
            try {
                const errorData = await res.json();
                errorMessage = errorData.message || errorMessage;
            } catch {
                const errorText = await res.text();
                errorMessage = errorText || errorMessage;
            }
            
            document.getElementById('registerMsg').innerText = errorMessage;
            document.getElementById('registerMsg').style.color = "red";
        }
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('registerMsg').innerText = "Erreur d'inscription";
        document.getElementById('registerMsg').style.color = "red";
    }
});
</script>