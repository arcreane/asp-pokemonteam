@{
  ViewData["Title"] = "PariPoke";
  Layout = "_Layout";
}

<h2>Course Pok√©mon - Parie ton Pok√©dollar</h2>

<label for="pokemon">Choisis ton Pok√©mon :</label>
<select id="pokemon">
  <option value="Pikachu">Pikachu</option>
  <option value="Bulbasaur">Bulbasaur</option>
  <option value="Charmander">Charmander</option>
  <option value="Squirtle">Squirtle</option>
</select>

<br />

<label for="mise">Montant du pari :</label>
<input id="mise" type="number" value="10" min="1" />

<br />

<button id="startRace">D√©marrer la course</button>

<div id="result"></div>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const game = urlParams.get('game');

  if (game) {
    // R√©cup√®re l'utilisateur connect√©
    fetch('/auth/check', { credentials: 'include' })
      .then(res => res.ok ? res.json() : Promise.reject('Not logged'))
      .then(async data => {
        const email = data.email;

        // V√©rifie si le Player existe pour ce jeu
        const resPlayer = await fetch(`/api/player/me?game=${game}`, { credentials: 'include' });

        if (resPlayer.ok) {
          const player = await resPlayer.json();
          document.getElementById('player-info').innerText = `üëã ${player.name}`;
        } else {
          // Cr√©e le Player automatiquement
          const prefix = email.split('@@')[0];
          const playerName = `${prefix}-${game}`;

          const createRes = await fetch('/api/player/create', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: playerName, game: game })
          });

          if (createRes.ok) {
            const newPlayer = await createRes.json();
            document.getElementById('player-info').innerText = `üëã ${newPlayer.name}`;
          } else {
            console.error("Erreur cr√©ation profil joueur");
          }
        }
      })
      .catch(err => console.log('Utilisateur non connect√©'));
  }
</script>

<script>
  document.getElementById('startRace').addEventListener('click', async () => {
    const selectedPokemon = document.getElementById('pokemon').value;
    const mise = parseInt(document.getElementById('mise').value);

    // Tirage au hasard du vainqueur
    const pokemons = ["Pikachu", "Bulbasaur", "Charmander", "Squirtle"];
    const winner = pokemons[Math.floor(Math.random() * pokemons.length)];

    let gain = 0;
    let message = "";

    if (selectedPokemon === winner) {
      gain = mise; // Gagne la mise en plus = x2
      message = `Bravo ! ${winner} a gagn√© ! Tu gagnes ${gain} pok√©dollars.`;
    } else {
      gain = 0; // Perte
      message = `Perdu ! ${winner} a gagn√© ! Tu perds 0 pok√©dollars.`;
    }

    // MAJ backend
    await fetch('/api/player/update', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        game: "PariPoke",
        experience: 0,
        pokedollar: gain
      })
    });

    document.getElementById('result').innerText = message;
  });
</script>



